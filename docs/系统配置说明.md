# FinLoom 系统配置说明

## 配置文件结构

```
config/
├── system_config.yaml      # 系统主配置
├── model_config.yaml        # 模型配置
└── trading_config.yaml      # 交易配置
```

---

## 1. 系统主配置 (system_config.yaml)

### 日志配置

```yaml
logging:
  level: INFO                    # 日志级别: DEBUG, INFO, WARNING, ERROR
  format: "%(asctime)s | %(levelname)s | %(name)s:%(funcName)s:%(lineno)d | %(message)s"
  file_path: "logs/system.log"  # 日志文件路径
  max_bytes: 10485760            # 单个日志文件最大大小 (10MB)
  backup_count: 5                # 保留的日志文件数量
```

### 数据库配置

```yaml
database:
  type: duckdb                   # 数据库类型
  path: "data/finloom.db"        # 数据库文件路径
  max_connections: 10            # 最大连接数
```

### 缓存配置

```yaml
cache:
  type: memory                   # 缓存类型: memory, redis
  max_size: 1000                 # 最大缓存条目数
  ttl_seconds: 3600              # 缓存过期时间（秒）
```

### 并发配置

```yaml
concurrency:
  max_workers: 4                 # 最大工作线程数
  thread_pool_size: 10           # 线程池大小
  async_timeout: 30              # 异步操作超时时间（秒）
```

### 系统监控

```yaml
monitoring:
  enable: true                   # 是否启用监控
  metrics_port: 8001             # 监控指标端口
  health_check_interval: 60      # 健康检查间隔（秒）
```

### AI模型配置（核心）

```yaml
ai_model:
  provider: aliyun  # 标识配置了阿里云（系统使用主备容错机制）
  
  # 阿里云备用服务配置
  aliyun:
    api_key: "sk-97c76c35db024c3094ac8efd814dada5"  # 阿里云API密钥
    model: "qwen-plus"   # 模型选择: qwen-turbo, qwen-plus, qwen-max
    temperature: 0.7     # 温度参数 (0-1, 越高越随机)
    max_tokens: 2000     # 最大生成token数
```

**重要说明**:
- 系统采用**主备容错机制**
- **主服务**: FIN-R1 本地模型（优先使用）
- **备用服务**: 阿里云API（FIN-R1失败时自动切换）
- API密钥需要从阿里云控制台获取: https://dashscope.console.aliyun.com/

---

## 2. 模型配置 (model_config.yaml)

### FIN-R1 本地模型配置

参见: `module_10_ai_interaction/config/fin_r1_config.yaml`

```yaml
model:
  model_path: ".Fin-R1"          # 模型文件路径
  device: "cpu"                  # 运行设备: cpu 或 cuda
  batch_size: 1                  # 批处理大小
  max_length: 2048               # 最大序列长度
  temperature: 0.7               # 生成温度
  top_p: 0.9                     # nucleus采样参数
  top_k: 50                      # top-k采样参数
  do_sample: true                # 是否启用采样
  repetition_penalty: 1.1        # 重复惩罚系数

performance:
  timeout: 30                    # 推理超时时间（秒）
  max_retries: 3                 # 最大重试次数
```

**优化建议**:
- 如有GPU，设置 `device: "cuda"` 可大幅提升速度
- 降低 `max_length` 可加快响应速度
- 调整 `temperature` 可控制输出随机性

---

## 3. 交易配置 (trading_config.yaml)

### 交易参数

```yaml
trading:
  # 交易时间
  market_open: "09:30"           # 市场开盘时间
  market_close: "15:00"          # 市场收盘时间
  
  # 风险控制
  max_position_size: 0.2         # 单个持仓最大比例 (20%)
  max_daily_loss: 0.05           # 单日最大损失 (5%)
  max_total_positions: 10        # 最大持仓数量
  
  # 交易成本
  commission_rate: 0.0003        # 佣金率 (0.03%)
  slippage_rate: 0.0005          # 滑点率 (0.05%)
  
  # 止损止盈
  default_stop_loss: 0.05        # 默认止损比例 (5%)
  default_take_profit: 0.15      # 默认止盈比例 (15%)
```

---

## 配置修改指南

### 修改日志级别

开发环境:
```yaml
logging:
  level: DEBUG
```

生产环境:
```yaml
logging:
  level: WARNING
```

### 配置阿里云API

1. 获取API密钥: https://dashscope.console.aliyun.com/
2. 修改 `system_config.yaml`:

```yaml
ai_model:
  provider: aliyun
  aliyun:
    api_key: "你的API密钥"
    model: "qwen-plus"  # 根据需求选择
```

### 切换AI模型

**使用qwen-turbo** (速度快，成本低):
```yaml
aliyun:
  model: "qwen-turbo"
  max_tokens: 1500
```

**使用qwen-max** (性能最强):
```yaml
aliyun:
  model: "qwen-max"
  max_tokens: 3000
```

### 启用GPU加速

修改 `module_10_ai_interaction/config/fin_r1_config.yaml`:

```yaml
model:
  device: "cuda"  # 需要CUDA环境
```

### 调整并发性能

高性能服务器:
```yaml
concurrency:
  max_workers: 8
  thread_pool_size: 20
```

低配置环境:
```yaml
concurrency:
  max_workers: 2
  thread_pool_size: 5
```

---

## 环境变量配置（推荐）

为了安全，建议将敏感信息存储在环境变量中。

创建 `.env` 文件:

```bash
# 阿里云配置
ALIYUN_API_KEY=sk-xxxxx
ALIYUN_MODEL=qwen-plus

# 数据库配置
DATABASE_PATH=data/finloom.db

# 日志级别
LOG_LEVEL=INFO
```

然后修改代码读取环境变量:

```python
import os
from dotenv import load_dotenv

load_dotenv()

api_key = os.getenv('ALIYUN_API_KEY')
```

---

## 配置验证

### 验证配置文件语法

```bash
# 使用Python验证YAML语法
python -c "import yaml; yaml.safe_load(open('config/system_config.yaml'))"
```

### 验证AI服务配置

```bash
# 运行测试脚本
python 测试混合AI服务.py
```

### 验证系统配置

```bash
# 启动系统并查看日志
python main.py --no-browser
```

---

## 常见问题

### Q1: 修改配置后需要重启吗？

A: 是的，配置文件在系统启动时加载，修改后需要重启服务。

### Q2: 如何禁用FIN-R1只使用阿里云？

A: 两种方法：
1. 删除或重命名 `.Fin-R1` 目录
2. 系统会自动检测并切换到阿里云

### Q3: 配置文件损坏怎么办？

A: 系统会使用默认配置。备份配置文件:
```bash
cp config/system_config.yaml config/system_config.yaml.backup
```

### Q4: 如何查看当前使用的配置？

A: 启动系统后查看日志:
```bash
tail -f logs/system.log | grep "Configuration loaded"
```

---

## 配置最佳实践

1. **定期备份配置**: 在修改前备份配置文件
2. **使用版本控制**: 将配置文件纳入Git管理
3. **环境分离**: 开发、测试、生产使用不同配置
4. **敏感信息保护**: 使用环境变量或密钥管理工具
5. **配置文档化**: 记录每次配置修改的原因和影响

---

## 配置模板

### 开发环境配置

```yaml
logging:
  level: DEBUG
  
concurrency:
  max_workers: 2
  
monitoring:
  enable: true
```

### 生产环境配置

```yaml
logging:
  level: WARNING
  
concurrency:
  max_workers: 8
  
monitoring:
  enable: true
  
ai_model:
  aliyun:
    model: "qwen-max"  # 使用最强模型
```

---

**配置修改建议**: 
- 从默认配置开始，逐步调整
- 监控系统性能和资源使用
- 根据实际需求优化参数

**最后更新**: 2025-10-10








