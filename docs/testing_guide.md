# FinLoom 阿里云API集成测试指南

## 测试准备

### 1. 配置API密钥

编辑 `config/system_config.yaml`：

```yaml
ai_model:
  provider: aliyun
  aliyun:
    api_key: "sk-your-actual-api-key"  # 替换为真实密钥
    model: "qwen-plus"
    temperature: 0.7
    max_tokens: 2000
```

### 2. 启动服务

```bash
python main.py
```

等待服务启动，确保看到类似日志：
```
🚀 阿里云AI服务初始化成功，使用模型: qwen-plus
✅ FastAPI server started on http://localhost:8000
```

## 功能测试

### 测试1：智能对话功能

#### 步骤：
1. 打开浏览器访问：`http://localhost:8000`
2. 登录后进入"智能对话"页面（或访问 `/dashboard/chat`）
3. 在输入框中输入测试问题

#### 测试用例：

**用例1.1 - 简单投资咨询**
```
输入：我有10万元，想进行稳健投资，请给我一些建议
预期：AI返回包含投资建议、风险提示的专业回复
```

**用例1.2 - 技术分析询问**
```
输入：如何判断一只股票是否值得投资？
预期：AI解释投资分析方法和关键指标
```

**用例1.3 - 市场趋势咨询**
```
输入：当前市场环境下，应该选择什么类型的投资策略？
预期：AI分析市场并给出策略建议
```

**用例1.4 - 风险管理**
```
输入：如何控制投资组合的风险？
预期：AI提供风险控制方法和建议
```

#### 验证点：
- ✅ 消息能正常发送
- ✅ AI回复速度在3-10秒内
- ✅ 回复内容专业、有条理
- ✅ 对话历史正常保存
- ✅ 可以进行多轮对话

---

### 测试2：策略生成功能

#### 步骤：
1. 进入"策略生成"页面（或访问 `/dashboard/strategy`）
2. 点击"开始生成策略"或直接输入需求

#### 测试用例：

**用例2.1 - 保守型策略**
```
需求描述：
我有50万元，希望建立一个保守型的投资组合，投资期限2年，
主要关注金融和消费行业，能承受5%以内的波动。

预期输出：
- 策略名称：如"稳健价值投资策略"
- 推荐股票：3-5只低风险股票
- 仓位配置：单只股票不超过25%
- 风险管理：明确的止损止盈设置
```

**用例2.2 - 成长型策略**
```
需求描述：
100万投资，希望获得较高收益，可以接受中等风险，
偏好科技和新能源行业，投资期限1年。

预期输出：
- 策略名称：如"科技成长策略"
- 推荐股票：包含科技和新能源板块
- 预期收益：15-20%年化
- 风险等级：中等
```

**用例2.3 - 均衡型策略**
```
需求描述：
30万元，追求稳健增值，投资时间6个月，
不限制行业，希望平衡收益和风险。

预期输出：
- 策略名称：如"均衡配置策略"
- 推荐股票：多行业分散
- 风险控制：明确的最大回撤限制
```

#### 验证点：
- ✅ 需求能正确解析
- ✅ 生成的策略符合用户需求
- ✅ 推荐的股票有合理的配置比例
- ✅ 包含明确的风险管理措施
- ✅ 预期收益和风险评估合理
- ✅ 可以保存生成的策略

---

## API测试

### 使用cURL测试

#### 测试智能对话API

```bash
curl -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "我有10万元想投资，请给我建议",
    "conversation_id": ""
  }'
```

**预期响应：**
```json
{
  "status": "success",
  "response": "根据您的情况，建议...",
  "conversation_id": "xxx",
  "model": "qwen-plus",
  "timestamp": "2025-10-09T..."
}
```

#### 测试策略生成API

```bash
curl -X POST http://localhost:8000/api/v1/strategy/generate \
  -H "Content-Type: application/json" \
  -d '{
    "requirements": {
      "description": "我有50万元，希望进行稳健投资，关注金融和消费行业"
    }
  }'
```

**预期响应：**
```json
{
  "status": "success",
  "data": {
    "strategy": {
      "id": "strategy_xxx",
      "name": "稳健价值投资策略",
      "recommended_stocks": [...],
      "risk_management": {...},
      ...
    }
  }
}
```

---

## 性能测试

### 响应时间测试

| 功能 | 预期响应时间 | 可接受范围 |
|------|-------------|-----------|
| 简单对话 | 2-5秒 | < 10秒 |
| 复杂策略生成 | 5-10秒 | < 15秒 |
| 需求解析 | 3-6秒 | < 10秒 |

### 并发测试

测试多个用户同时使用：
```bash
# 安装ab工具后
ab -n 10 -c 2 -p post_data.json -T application/json \
  http://localhost:8000/api/chat
```

---

## 常见问题排查

### 问题1：API密钥错误

**症状：**
```
错误: 阿里云API密钥未配置
```

**解决：**
1. 检查 `config/system_config.yaml` 中的 `api_key` 是否填写
2. 确认不是默认值 `YOUR_ALIYUN_API_KEY`
3. 验证API密钥格式（通常以 `sk-` 开头）

### 问题2：网络连接失败

**症状：**
```
错误: 阿里云API调用失败: Connection timeout
```

**解决：**
1. 检查网络连接
2. 确认能访问 `https://dashscope.aliyuncs.com`
3. 检查防火墙设置

### 问题3：API响应慢

**症状：**
- 回复时间超过15秒

**解决：**
1. 检查网络延迟
2. 尝试更换模型（qwen-turbo 更快）
3. 减少 `max_tokens` 参数
4. 查看阿里云控制台API调用统计

### 问题4：回复质量不理想

**解决：**
1. 调整 `temperature` 参数：
   - 降低（0.3-0.5）：更保守、确定性强
   - 提高（0.8-1.0）：更有创造性
2. 更换更强大的模型（qwen-max）
3. 在提问时提供更多上下文信息

---

## 日志查看

查看详细日志：
```bash
tail -f logs/system.log | grep "阿里云"
```

查看错误日志：
```bash
grep "ERROR" logs/system.log | grep -i "aliyun\|api"
```

---

## 测试清单

### 功能完整性
- [ ] 智能对话正常工作
- [ ] 策略生成正常工作
- [ ] 多轮对话上下文正确
- [ ] 错误处理正常
- [ ] 对话历史保存正常

### 性能测试
- [ ] 响应时间在可接受范围
- [ ] 并发请求正常处理
- [ ] 系统资源使用正常

### 用户体验
- [ ] 回复内容专业、有用
- [ ] 界面交互流畅
- [ ] 错误提示清晰
- [ ] 加载状态明确

---

## 下一步

测试通过后：
1. 配置生产环境API密钥
2. 设置监控和告警
3. 定期检查API使用量
4. 收集用户反馈，优化提示词

---

**测试完成后，请记录测试结果并报告任何问题！** ✅









