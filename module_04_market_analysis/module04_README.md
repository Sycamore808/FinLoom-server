# Module 04 - å¸‚åœºåˆ†ææ¨¡å— (Enhanced with Trading Agents)

## æ¦‚è¿°

å¸‚åœºåˆ†ææ¨¡å—æ˜¯ FinLoom é‡åŒ–äº¤æ˜“ç³»ç»Ÿçš„æ ¸å¿ƒæ™ºèƒ½åˆ†æç»„ä»¶ï¼Œé›†æˆäº†å…ˆè¿›çš„å¤šæ™ºèƒ½ä½“äº¤æ˜“åˆ†ææ¡†æ¶ï¼Œä½¿ç”¨çœŸå®çš„ä¸­å›½Aè‚¡æ•°æ®è¿›è¡Œæ·±åº¦å¸‚åœºåˆ†æã€‚è¯¥æ¨¡å—å·²å®Œå…¨æ•´åˆåŸTrading AgentsåŠŸèƒ½ï¼Œæä¾›æ›´å¼ºå¤§ã€æ›´æ™ºèƒ½çš„å¸‚åœºåˆ†æèƒ½åŠ›ã€‚

## ğŸš€ ä¸»è¦ç‰¹æ€§

### 1. å¤šæ™ºèƒ½ä½“åˆ†æç³»ç»Ÿ
- **æƒ…æ„Ÿåˆ†æå¸ˆ**: é›†æˆFIN-R1æ¨¡å‹å’Œæ–°é—»æƒ…æ„Ÿåˆ†æ
- **åŸºæœ¬é¢åˆ†æå¸ˆ**: è´¢åŠ¡æ•°æ®å’Œå®è§‚ç»æµåˆ†æ  
- **æŠ€æœ¯åˆ†æå¸ˆ**: æŠ€æœ¯æŒ‡æ ‡å’Œå›¾è¡¨å½¢æ€è¯†åˆ«
- **é£é™©ç®¡ç†å¸ˆ**: é£é™©è¯„ä¼°å’ŒæŠ•èµ„å»ºè®®
- **æ™ºèƒ½ä½“åè°ƒå™¨**: å¤šè½®è¾©è®ºå’Œå…±è¯†æ„å»º

### 2. å¢å¼ºçš„æƒ…æ„Ÿåˆ†æ
- **FIN-R1æ¨¡å‹é›†æˆ**: ä¸“ä¸šé‡‘èæ–‡æœ¬æƒ…æ„Ÿåˆ†æ
- **æ–°é—»æƒ…æ„Ÿåˆ†æ**: å®æ—¶æ–°é—»å’Œç¤¾äº¤åª’ä½“æƒ…ç»ªè¿½è¸ª
- **å¸‚åœºæƒ…æ„Ÿèšåˆ**: å¤šæºæƒ…æ„Ÿæ•°æ®ç»¼åˆåˆ†æ
- **æƒ…æ„Ÿè¶‹åŠ¿è¿½è¸ª**: å†å²æƒ…æ„Ÿå˜åŒ–è¶‹åŠ¿åˆ†æ

### 3. å¼‚å¸¸æ£€æµ‹ä¸é¢„è­¦
- **ä»·æ ¼å¼‚å¸¸æ£€æµ‹**: åŸºäºç»Ÿè®¡å’Œæœºå™¨å­¦ä¹ çš„ä»·æ ¼å¼‚å¸¸è¯†åˆ«
- **æˆäº¤é‡å¼‚å¸¸**: äº¤æ˜“é‡å¼‚å¸¸å˜åŒ–æ£€æµ‹
- **æŠ€æœ¯å½¢æ€å¼‚å¸¸**: å›¾è¡¨å½¢æ€çªç ´å’Œåè½¬æ£€æµ‹
- **å¤šç»´åº¦å¼‚å¸¸**: ç»¼åˆå¤šä¸ªç»´åº¦çš„å¼‚å¸¸è¯„åˆ†

## ğŸ“Š æ•°æ®é›†æˆ

### Module 1 æ•°æ®æºé›†æˆ
- **å®æ—¶è¡Œæƒ…æ•°æ®**: AkshareDataCollector
- **å®è§‚ç»æµæ•°æ®**: ä¸­å›½GDPã€CPIã€PMIç­‰æŒ‡æ ‡
- **æ–°é—»æ•°æ®**: æ–°é—»è”æ’­ã€è´¢ç»æ–°é—»ã€ä¸ªè‚¡æ–°é—»
- **åŸºæœ¬é¢æ•°æ®**: è´¢åŠ¡æŠ¥è¡¨ã€è´¢åŠ¡æŒ‡æ ‡ã€åˆ†çº¢æ•°æ®

### Module 2 æŠ€æœ¯æŒ‡æ ‡é›†æˆ
- **æŠ€æœ¯æŒ‡æ ‡è®¡ç®—**: ç§»åŠ¨å¹³å‡ã€RSIã€MACDã€å¸ƒæ—å¸¦
- **ç‰¹å¾å·¥ç¨‹**: æ—¶é—´åºåˆ—ç‰¹å¾ã€å›¾ç½‘ç»œç‰¹å¾
- **å› å­åˆ†æ**: å¤šå› å­æ¨¡å‹å’Œå› å­å‘ç°

### ä¸“ç”¨æ•°æ®åº“å­˜å‚¨
- **SQLiteæ•°æ®åº“**: `/data/module04_market_analysis.db`
- **åˆ†æç»“æœå­˜å‚¨**: æ™ºèƒ½ä½“åˆ†æå†å²å’Œå…±è¯†ç»“æœ
- **æƒ…æ„Ÿåˆ†æè®°å½•**: æƒ…æ„Ÿåˆ†æå†å²å’Œè¶‹åŠ¿æ•°æ®
- **å¼‚å¸¸æ£€æµ‹è®°å½•**: å¼‚å¸¸äº‹ä»¶å’Œé¢„è­¦å†å²

## ğŸ”§ å®‰è£…å’Œé…ç½®

### ç¯å¢ƒè¦æ±‚
```bash
# æ¿€æ´»condaç¯å¢ƒ
conda activate study

# ç¡®ä¿å¿…è¦çš„ä¾èµ–åŒ…å·²å®‰è£…
pip install fastapi uvicorn pandas numpy scipy scikit-learn
pip install transformers torch  # ç”¨äºFIN-R1æ¨¡å‹
```

### æ•°æ®åº“åˆå§‹åŒ–
æ•°æ®åº“ä¼šåœ¨é¦–æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨åˆ›å»ºï¼Œä½ç½®ï¼š
```
/Users/victor/Desktop/25fininnov/FinLoom-server/data/module04_market_analysis.db
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºç¡€ä½¿ç”¨ç¤ºä¾‹

```python
import asyncio
from module_04_market_analysis.sentiment_analysis.fin_r1_sentiment import get_sentiment_analyzer

async def basic_example():
    # åŸºç¡€æƒ…æ„Ÿåˆ†æ
    analyzer = get_sentiment_analyzer()
    symbols = ["000001", "600036", "000858"]  # å¹³å®‰é“¶è¡Œã€æ‹›å•†é“¶è¡Œã€äº”ç²®æ¶²
    
    # åˆ†æè‚¡ç¥¨æƒ…æ„Ÿ
    result = await analyzer.analyze_stock_sentiment(symbols)
    print(f"æ•´ä½“æƒ…æ„Ÿåˆ†æ•°: {result['overall_sentiment']['sentiment_score']:.3f}")
    
    # åˆ†æå¸‚åœºæƒ…æ„Ÿ
    market_result = await analyzer.analyze_market_sentiment()
    print(f"å¸‚åœºæƒ…æ„Ÿåˆ†æ•°: {market_result['overall_sentiment']:.3f}")

# è¿è¡Œç¤ºä¾‹
asyncio.run(basic_example())
```

### 2. å¢å¼ºæƒ…æ„Ÿåˆ†æï¼ˆé›†æˆåŸºæœ¬é¢ï¼‰

```python
from module_04_market_analysis.sentiment_analysis.enhanced_news_sentiment import EnhancedNewsSentimentAnalyzer

async def enhanced_sentiment_example():
    # å¢å¼ºæƒ…æ„Ÿåˆ†æï¼ˆæ–°é—»+åŸºæœ¬é¢ï¼‰
    enhanced_analyzer = EnhancedNewsSentimentAnalyzer()
    symbols = ["000001", "600036"]
    
    # ç»¼åˆåˆ†æ
    result = await enhanced_analyzer.analyze_comprehensive_sentiment(symbols)
    
    for symbol, analysis in result['individual_results'].items():
        print(f"{symbol}:")
        print(f"  æœ€ç»ˆæƒ…æ„Ÿ: {analysis['final_sentiment_label']}")
        print(f"  ç½®ä¿¡åº¦: {analysis['final_confidence']:.2f}")
        print(f"  æŠ•èµ„å»ºè®®: {analysis['recommendation']}")

asyncio.run(enhanced_sentiment_example())
```

## ğŸ“¡ REST API æ¥å£

### å¯åŠ¨APIæœåŠ¡å™¨

```python
from fastapi import FastAPI
from module_04_market_analysis.api.market_analysis_api import router

app = FastAPI(title="Market Analysis API")
app.include_router(router)

# è¿è¡ŒæœåŠ¡å™¨
# uvicorn main:app --host 0.0.0.0 --port 8000
```

### API ç«¯ç‚¹

#### 1. æƒ…æ„Ÿåˆ†æç«¯ç‚¹

**POST /api/v1/market/sentiment/analyze**
```bash
curl -X POST "http://localhost:8000/api/v1/market/sentiment/analyze" \
     -H "Content-Type: application/json" \
     -d '{
       "symbols": ["000001", "600036"],
       "include_fundamentals": true
     }'
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "status": "success",
  "data": {
    "overall_sentiment": {
      "sentiment_score": 0.234,
      "sentiment_label": "positive",
      "confidence": 0.78
    },
    "individual_stocks": {
      "000001": {
        "sentiment_score": 0.156,
        "sentiment_label": "positive",
        "confidence": 0.82,
        "news_count": 15
      }
    }
  },
  "timestamp": "2024-01-15T10:30:00"
}
```

#### 2. å¸‚åœºæƒ…æ„Ÿç«¯ç‚¹

**GET /api/v1/market/sentiment/market**
```bash
curl "http://localhost:8000/api/v1/market/sentiment/market"
```

#### 3. è‚¡ç¥¨æ•°æ®ç«¯ç‚¹

**GET /api/v1/market/data/stocks/{symbol}**
```bash
curl "http://localhost:8000/api/v1/market/data/stocks/000001?period=30"
```

#### 4. å®æ—¶æ•°æ®ç«¯ç‚¹

**GET /api/v1/market/data/realtime**
```bash
curl "http://localhost:8000/api/v1/market/data/realtime?symbols=000001&symbols=600036"
```

#### 5. å¥åº·æ£€æŸ¥ç«¯ç‚¹

**GET /api/v1/market/health**
```bash
curl "http://localhost:8000/api/v1/market/health"
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "status": "healthy",
  "timestamp": "2024-01-15T10:30:00",
  "services": {
    "data_collector": true,
    "sentiment_analyzer": true,
    "enhanced_sentiment": true,
    "database": true
  }
}
```

## ğŸ”§ æ¨¡å—é—´è°ƒç”¨æ–¹æ³•

### ä»å…¶ä»–æ¨¡å—è°ƒç”¨ Module 4

#### 1. Pythonç¨‹åºè°ƒç”¨
```python
# åœ¨å…¶ä»–æ¨¡å—ä¸­å¯¼å…¥å’Œä½¿ç”¨
from module_04_market_analysis.sentiment_analysis.fin_r1_sentiment import (
    get_sentiment_analyzer,
    analyze_symbol_sentiment,
    analyze_market_sentiment
)

# å¼‚æ­¥è°ƒç”¨
import asyncio

async def analyze_market():
    # åˆ†æç‰¹å®šè‚¡ç¥¨æƒ…æ„Ÿ
    result = await analyze_symbol_sentiment(["000001", "600036"])
    return result

# åŒæ­¥è°ƒç”¨åŒ…è£…
def sync_analyze_market():
    return asyncio.run(analyze_market())
```

#### 2. ä» Module 9 (å›æµ‹) è°ƒç”¨
```python
# åœ¨å›æµ‹æ¨¡å—ä¸­è·å–å¸‚åœºæƒ…æ„Ÿæ•°æ®
from module_04_market_analysis.sentiment_analysis.fin_r1_sentiment import get_sentiment_analyzer

class BacktestEngine:
    def __init__(self):
        self.sentiment_analyzer = get_sentiment_analyzer()
    
    async def get_market_sentiment_for_date(self, date, symbols):
        # è·å–æŒ‡å®šæ—¥æœŸçš„å¸‚åœºæƒ…æ„Ÿ
        sentiment_data = await self.sentiment_analyzer.analyze_stock_sentiment(symbols)
        return sentiment_data
```

### å‰åç«¯APIäº¤äº’

#### 1. å‰ç«¯JavaScriptè°ƒç”¨ç¤ºä¾‹
```javascript
// å‰ç«¯è°ƒç”¨å¸‚åœºåˆ†æAPI
class MarketAnalysisClient {
    constructor(baseUrl = 'http://localhost:8000') {
        this.baseUrl = baseUrl;
    }
    
    // åˆ†æè‚¡ç¥¨æƒ…æ„Ÿ
    async analyzeStockSentiment(symbols, includeFundamentals = true) {
        const response = await fetch(`${this.baseUrl}/api/v1/market/sentiment/analyze`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                symbols: symbols,
                include_fundamentals: includeFundamentals
            })
        });
        
        if (!response.ok) {
            throw new Error(`API call failed: ${response.statusText}`);
        }
        
        return await response.json();
    }
    
    // è·å–å¸‚åœºæƒ…æ„Ÿ
    async getMarketSentiment() {
        const response = await fetch(`${this.baseUrl}/api/v1/market/sentiment/market`);
        return await response.json();
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const client = new MarketAnalysisClient();

// åˆ†ææƒ…æ„Ÿ
client.analyzeStockSentiment(['000001', '600036'])
    .then(result => {
        console.log('æƒ…æ„Ÿåˆ†æç»“æœ:', result);
        updateSentimentDisplay(result.data);
    })
    .catch(error => {
        console.error('åˆ†æå¤±è´¥:', error);
    });
```

#### 2. Reactç»„ä»¶ç¤ºä¾‹
```jsx
import React, { useState, useEffect } from 'react';

const MarketAnalysisComponent = () => {
    const [sentimentData, setSentimentData] = useState(null);
    const [loading, setLoading] = useState(false);
    const [symbols] = useState(['000001', '600036', '000858']);
    
    const analyzeSentiment = async () => {
        setLoading(true);
        try {
            const response = await fetch('/api/v1/market/sentiment/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    symbols: symbols,
                    include_fundamentals: true
                })
            });
            
            const result = await response.json();
            setSentimentData(result.data);
        } catch (error) {
            console.error('æƒ…æ„Ÿåˆ†æå¤±è´¥:', error);
        } finally {
            setLoading(false);
        }
    };
    
    useEffect(() => {
        analyzeSentiment();
    }, []);
    
    return (
        <div className="market-analysis">
            <h2>å¸‚åœºæƒ…æ„Ÿåˆ†æ</h2>
            
            {loading && <div>æ­£åœ¨åˆ†æä¸­...</div>}
            
            {sentimentData && (
                <div>
                    <div className="overall-sentiment">
                        <h3>æ•´ä½“æƒ…æ„Ÿ</h3>
                        <p>åˆ†æ•°: {sentimentData.overall_sentiment.sentiment_score.toFixed(3)}</p>
                        <p>æ ‡ç­¾: {sentimentData.overall_sentiment.sentiment_label}</p>
                        <p>ç½®ä¿¡åº¦: {sentimentData.overall_sentiment.confidence.toFixed(2)}</p>
                    </div>
                    
                    <div className="individual-stocks">
                        <h3>ä¸ªè‚¡æƒ…æ„Ÿ</h3>
                        {Object.entries(sentimentData.individual_stocks).map(([symbol, data]) => (
                            <div key={symbol} className="stock-sentiment">
                                <h4>{symbol}</h4>
                                <p>æƒ…æ„Ÿ: {data.sentiment_label}</p>
                                <p>åˆ†æ•°: {data.sentiment_score.toFixed(3)}</p>
                                <p>ç½®ä¿¡åº¦: {data.confidence.toFixed(2)}</p>
                            </div>
                        ))}
                    </div>
                </div>
            )}
            
            <button onClick={analyzeSentiment} disabled={loading}>
                åˆ·æ–°åˆ†æ
            </button>
        </div>
    );
};

export default MarketAnalysisComponent;
```

## ğŸ§ª æµ‹è¯•å’ŒéªŒè¯

### è¿è¡Œæµ‹è¯•
```bash
# æ¿€æ´»condaç¯å¢ƒ
conda activate study

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /Users/victor/Desktop/25fininnov/FinLoom-server

# è¿è¡ŒModule 4æµ‹è¯•
python tests/module04_market_analysis_test.py
```

### æµ‹è¯•è¦†ç›–å†…å®¹
1. **æ¨¡å—å¯¼å…¥æµ‹è¯•**: éªŒè¯æ‰€æœ‰ç»„ä»¶æ­£ç¡®å¯¼å…¥
2. **çœŸå®æ•°æ®é‡‡é›†**: æµ‹è¯•æ•°æ®æºé›†æˆ
3. **æƒ…æ„Ÿåˆ†æåŠŸèƒ½**: æµ‹è¯•FIN-R1å’Œå¢å¼ºæƒ…æ„Ÿåˆ†æ
4. **å¼‚å¸¸æ£€æµ‹**: æµ‹è¯•ä»·æ ¼ã€æˆäº¤é‡å’Œå¤šç»´å¼‚å¸¸æ£€æµ‹
5. **ç›¸å…³æ€§åˆ†æ**: æµ‹è¯•è‚¡ç¥¨ç›¸å…³æ€§è®¡ç®—
6. **å¸‚åœºçŠ¶æ€æ£€æµ‹**: æµ‹è¯•HMMå’Œå…¶ä»–çŠ¶æ€æ£€æµ‹æ–¹æ³•
7. **æ•°æ®åº“æ“ä½œ**: æµ‹è¯•SQLiteå­˜å‚¨å’Œæ£€ç´¢
8. **APIç»“æ„**: éªŒè¯REST APIç«¯ç‚¹
9. **é›†æˆå·¥ä½œæµ**: ç«¯åˆ°ç«¯æ•°æ®æµæµ‹è¯•

### é¢„æœŸæµ‹è¯•ç»“æœ
```
Module 04 Market Analysis - Comprehensive Test Suite
============================================================
Testing market analysis with real A-share data
Database: /Users/victor/Desktop/25fininnov/FinLoom-server/data/module04_market_analysis.db
============================================================

Test 1: Module Imports Test
âœ“ Sentiment analysis imports successful
âœ“ Anomaly detection imports successful
âœ“ Correlation analysis imports successful
âœ“ Regime detection imports successful
âœ“ Database imports successful
âœ“ API imports successful

Test 2: Real Data Integration Test
âœ“ 000001: å¹³å®‰é“¶è¡Œ - é“¶è¡Œ
âœ“ 600036: æ‹›å•†é“¶è¡Œ - é“¶è¡Œ
âœ“ 000858: äº”ç²®æ¶² - ç™½é…’
âœ“ Data integration successful

ğŸ‰ ALL TESTS PASSED! Module 04 is ready for use.
```

## â“ å¸¸è§é—®é¢˜

### 1. å¯¼å…¥é”™è¯¯
```bash
ImportError: No module named 'module_01_data_pipeline'
```
**è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿åœ¨æ­£ç¡®çš„condaç¯å¢ƒä¸­è¿è¡Œ
```bash
conda activate study
```

### 2. æ•°æ®åº“è¿æ¥é”™è¯¯
```bash
sqlite3.OperationalError: database is locked
```
**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æƒé™ï¼Œé‡å¯æœåŠ¡

### 3. APIè¿æ¥é—®é¢˜
```bash
ConnectionError: Failed to connect to API
```
**è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿ä¸»æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ
```bash
python main.py
```

### 4. FIN-R1æ¨¡å‹é—®é¢˜
```bash
Model not found or failed to load
```
**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥æ¨¡å‹è·¯å¾„æˆ–ä½¿ç”¨å…³é”®è¯åˆ†æåå¤‡æ–¹æ¡ˆ

### è°ƒè¯•æ¨¡å¼
```python
import logging
logging.basicConfig(level=logging.DEBUG)

# å¯ç”¨è¯¦ç»†æ—¥å¿—
from module_04_market_analysis.sentiment_analysis.fin_r1_sentiment import FINR1SentimentAnalyzer
analyzer = FINR1SentimentAnalyzer()
```